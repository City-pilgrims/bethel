{% extends 'base_way.html' %}
{% load bootstrap4 %}
{% load static %}
{% load custom_filters %}

{% block content %}
    <style>
        /* 미리보기 스타일 */
        .preview-container {
            display: flex;
            justify-content: center; /* 가운데 정렬 */
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .preview-item {
            text-align: center;
        }

        .preview-item img {
            width: 80%;
            max-width: 400px;
            height: auto;
            display: block;
            margin: 0 auto; /* 가운데 정렬 */
        }
        .uploadItem { margin-bottom: 30px; }

        /* 업로드 입력창 스타일 */
        .uploadItem {
            margin-bottom: 30px;
            text-align: center;
        }

        .uploadItem input[type="file"] {
            display: block;
            margin: 10px auto;
        }

        .uploadItem img {
            width: 100%;
            height: auto;
            display: block;
            margin: 0 auto; /* 가운데 정렬 */
        }

        .uploadItem textarea[type="text"] {

            margin: 10px auto; /* 설명 입력창도 중앙 정렬 */
            padding: 8px;
            width: 90%;
            height: 80px;
            max-width: 400px;
            border: 1px solid #ccc;
            border-radius: 5px;
            resize: vertical;
        }

        .description-input {
            width: 80%;  /* 너비를 100%로 설정 */
            height: 80px;  /* 기본 높이 설정 */
            padding: 8px;  /* 내부 여백 */
            max-width: 400px;
            border: 1px solid #ccc;
            border-radius: 5px;
            resize: vertical;
        }

        .uploadItem input[type="text_group"] {
            display: block;
            margin: 10px auto; /* 설명 입력창도 중앙 정렬 */
            padding: 8px;
            width: 80%;
            height: 40px;
            max-width: 400px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
    </style>


    <!-- ------------------------------ Content ------------------------------------- -->
    <div style="text-align: center; margin-bottom: 1.2rem;">
        <p style="font-family: NanumDdoBagDdoBag; font-weight: bold; font-size:1.8rem;">특별 순례 기록 업데이트</p
    </div>

    <form id="updateForm" enctype="multipart/form-data">
        {% csrf_token %}

        <label for="pil_group">순례지:</label>
        <select id="pil_group" name="pil_group" onchange="toggleCustomInput(this)">
            <option value="#">선택하세요</option>
            <option value="Sydney" {% if special_pilgrim.group == "Sydney" %}selected{% endif %}>Sydney</option>
            <option value="Ryukyu" {% if special_pilgrim.group == "Ryukyu" %}selected{% endif %}>Ryukyu</option>
            <option value="낙동강" {% if special_pilgrim.group == "낙동강" %}selected{% endif %}>낙동강</option>
            <option value="서울" {% if special_pilgrim.group == "서울" %}selected{% endif %}>서울</option>
            <option value="DMZ" {% if special_pilgrim.group == "DMZ" %}selected{% endif %}>DMZ</option>
            <option value="Israel" {% if special_pilgrim.group == "Israel" %}selected{% endif %}>Israel</option>
            <option value="Pacific" {% if special_pilgrim.group == "Pacific" %}selected{% endif %}>Pacific</option>
            <option value="custom_group">직접입력</option>
        </select>

        <div class="uploadItem">
            <input type="text_group" name="pil_group_custom" id="pil_group_custom" placeholder="직접입력"
                   style="{% if special_pilgrim.group not in 'sydney ryukyu nakdong seoul dmz israel pacific' %}display: block{% else %}display: none{% endif %}"
                   value="{{ special_pilgrim.group }}">
        </div>
        <P style="font-family: NanumDdoBagDdoBag; font-weight: bold; font-size: 1.5rem;">기존 이미지 및 설명</P>
        <div id="existingItems">
            {% for image, description in image_description_pairs %}
                <div class="uploadItem">
                    <input type="hidden" name="description_ids" value="{{ description.id }}">
                    <textarea type="text" name="existing_descriptions" value="{{ description.text }}" placeholder="설명 입력">{{ description.text }}</textarea>
                    <img src="{{ image.image.url }}">
                </div>
            {% endfor %}
        </div>

        <P style="font-family: NanumDdoBagDdoBag; font-weight: bold; font-size: 1.5rem;">새로운 이미지 및 설명 추가</P>
        <div id="uploadContainer">
            <div class="uploadItem">
                <input type="file" name="new_images" accept="image/*" onchange="previewImage(event, this)">
                <textarea type="text" name="new_descriptions" placeholder="새로운 설명 입력"></textarea>
                <div class="preview-container"></div>
            </div>
        </div>


        <button type="button" onclick="addUploadField()" class = "btn btn-light">
            사진/설명 추가
        </button>
        <br>
        <br>
        <!-- 제출 버튼 -->
        <div class="container mt-4">
            <!-- 버튼 -->
            <div class="d-flex justify-content-between" style="margin: 0 1rem;">
                <a href="{% url 'wayapp:splist' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-1"></i>등록 취소
                </a>
                <button type="button" onclick="updateItems()" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i>업데이트
                </button>
            </div>
        </div>
    </form>


    <!-- ---------------------------------- Script ------------------------------------------ -->
    <script>
        function addUploadField() {
            let container = document.getElementById("uploadContainer");
            let newInput = `<div class="uploadItem">
                <input type="file" name="new_images" accept="image/*">
                <textarea type="text" name="new_descriptions" placeholder="설명 입력" class="description-input" rows="4"></textarea>
                <div class="preview-container"></div>
                <button type="button" onclick="removeUploadField(this)" class="btn btn-danger rounded-pill btn-sm col-2 mt-2">삭제</button>
            </div>`;
            container.insertAdjacentHTML("beforeend", newInput);
        }

        function removeUploadField(button) {
            button.parentElement.remove();
        }

        function updateItems() {
            const formData = new FormData(document.querySelector('#updateForm'));
            const spUpdateUrl = "{% url 'wayapp:spupdate' special_pilgrim.pk %}";

            fetch(spUpdateUrl, {
                method: 'POST',
                headers: { 'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("업데이트 성공!");
                    window.location.href = `{% url 'wayapp:spdetail' special_pilgrim.pk %}`;
                } else {
                    alert("오류: " + data.error);
                }
            });
        }

        function previewImage(event, input) {
            const previewContainer = input.nextElementSibling.nextElementSibling; // 미리보기 컨테이너
            previewContainer.innerHTML = ''; // 기존 미리보기 삭제

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.alt = '미리보기';

                    // 이미지 크기 조절 (JS에서 강제 적용)
                    img.style.width = "80%";
                    img.style.setProperty("max-width", "400px", "important");

                    previewContainer.appendChild(img);
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function toggleCustomInput(select) {
            var customInput = document.getElementById("pil_group_custom");
            if (select.value === "custom_group") {
                customInput.style.display = "block";  // 기타 선택 시 입력 필드 보이기
            } else {
                customInput.style.display = "none";   // 기본 옵션 선택 시 숨기기
                customInput.value = "";  // 기존 입력값 초기화
            }
        }
    </script>

{% endblock %}